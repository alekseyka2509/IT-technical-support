<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="burger.js"></script>
    <script src="mask.js"></script>
  </head>

  <body>
    <main class="page">
      <header class="main-header">
        <div class="container">
          <a href="index.html" class="logo">IT-поддержка</a>

          <div class="menu-wrapper">
            <div class="burger" id="burger">
              <span></span>
              <span></span>
              <span></span>
            </div>

            <div class="dropdown-menu" id="dropdown-menu">
              <a href="index.html">О нас</a>
              <a href="index.html#carusel">Тарифы</a>
              <a href="index.html#contact">Контакты</a>
              <a href="works.html">Работы</a>
              <a href="review.html">Отзывы</a>
              <hr />
              <a href="login.html"><button class="btn ghost">Вход</button></a>
              <a href="register.html"
                ><button class="btn primary">Регистрация</button></a
              >
            </div>
          </div>
        </div>
      </header>
      <div class="card">
        <div class="profile-container">
          <h2>Личный кабинет</h2>
          <div id="view-mode">
            <div class="profile-item">
              <span>ФИО:</span> <span id="fio">Иванов Иван Иванович</span>
            </div>
            <div class="profile-item">
              <span>Email:</span> <span id="email">ivanov@example.com</span>
            </div>
            <div class="profile-item">
              <span>Тариф:</span> <span id="plan">Premium</span>
            </div>
            <div class="profile-item">
              <span>Дата регистрации:</span> <span id="date">12.05.2023</span>
            </div>
            <div class="profile-item">
              <span>Телефон:</span> <span id="phone">+7 (900) 123-45-67</span>
            </div>
            <div class="profile-item">
              <span>Город:</span> <span id="city">Москва</span>
            </div>
            <button class="edit-btn" onclick="enterEditMode()">
              Редактировать
            </button>
            <button type="button" class="logout-btn" id="logoutBtn">Выйти</button>
          </div>

          <form id="edit-mode" class="edit-form">
            <input type="text" id="edit-fio" placeholder="ФИО" />
            <input type="email" id="edit-email" placeholder="Email" disabled />
            <input type="text" id="edit-plan" placeholder="Тариф" disabled />
            <input type="text" id="edit-date" placeholder="Дата регистрации" disabled />
            <input type="tel" id="edit-phone" name="phone" placeholder="+7 (___) ___-__-__" />
            <input type="text" id="edit-city" name="city" placeholder="Город" data-mask="city" />
            <button type="button" class="save-btn" onclick="saveChanges()">
              Сохранить
            </button>
            <button type="button" class="cancel-btn" onclick="cancelEdit()">
              Отмена
            </button>
          </form>
        </div>
        <footer class="card-footer">
          <div>© 2025 Компания</div>
          <div class="footer-links">
            <a href="#">Политика</a>
            <a href="#">Поддержка</a>
          </div>
        </footer>
      </div>
    </main>
    <script>
      const fioEl = document.getElementById("fio");
      const emailEl = document.getElementById("email");
      const planEl = document.getElementById("plan");
      const dateEl = document.getElementById("date");
      const phoneEl = document.getElementById("phone");
      const cityEl = document.getElementById("city");

      const editForm = document.getElementById("edit-mode");
      const viewMode = document.getElementById("view-mode");

      function enterEditMode() {
        editForm.style.display = "block";
        viewMode.style.display = "none";

        document.getElementById("edit-fio").value = fioEl.textContent;
        document.getElementById("edit-email").value = emailEl.textContent;
        document.getElementById("edit-plan").value = planEl.textContent;
        document.getElementById("edit-date").value = dateEl.textContent;
        document.getElementById("edit-phone").value = phoneEl.textContent;
        document.getElementById("edit-city").value = cityEl.textContent;

        document.querySelector(".save-btn").style.display = "block";
        document.querySelector(".cancel-btn").style.display = "block";
      }

      function saveChanges() {
        const payload = {
          full_name: document.getElementById("edit-fio").value,
          phone: document.getElementById("edit-phone").value,
          city: document.getElementById("edit-city").value
        };
        fetch('/api/me', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(async (res) => {
          if (!res.ok) {
            const errorData = await res.json();
            if (errorData.error === 'phone_exists') {
              alert('Этот номер телефона уже используется другим пользователем');
            } else {
              alert('Не удалось сохранить изменения');
            }
            return;
          }
          fioEl.textContent = payload.full_name;
          phoneEl.textContent = payload.phone;
          cityEl.textContent = payload.city;
          cancelEdit();
        }).catch(() => alert('Ошибка сети'));
      }

      function cancelEdit() {
        editForm.style.display = "none";
        viewMode.style.display = "block";
        document.querySelector(".save-btn").style.display = "none";
        document.querySelector(".cancel-btn").style.display = "none";
      }

      // Logout logic: call API then update menu and redirect to home
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/logout', { method: 'POST' });
            // Update burger menu to show login/register
            if (window.setMenuLoggedOut) window.setMenuLoggedOut();
            // Redirect to home or login page
            window.location.href = 'index.html';
          } catch (_) {
            window.location.href = 'index.html';
          }
        });
      }
    </script>
  </body>
</html>
